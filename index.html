<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ระบบแจ้งเตือนตามปฏิทิน-Js</title>

    <!-- โหลด jQuery ก่อน -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/2.0.7/css/dataTables.bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/3.0.2/css/responsive.bootstrap5.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">

    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">

    <!-- Include flatpickr -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>


    <style>
        /* กำหนดขนาดและลักษณะของกล่องที่แสดง description */
        .fc-event-title-container {
            max-height: 40px;
            /* กำหนดความสูงสูงสุด */
            overflow: hidden;
            /* ซ่อนข้อความที่เกิน */
            text-overflow: ellipsis;
            /* ใช้ "..." เมื่อข้อความยาวเกิน */
            white-space: nowrap;
            /* ไม่ให้ข้อความแสดงหลายบรรทัด */
            cursor: pointer;
            /* เปลี่ยน cursor เป็น pointer เมื่อ hover */
        }

        /* กำหนดการแสดงข้อความเมื่อเลื่อนเมาส์ */
        .fc-event-title-container:hover {
            max-height: none;
            /* แสดงข้อความทั้งหมดเมื่อ hover */
            white-space: normal;
            /* ให้ข้อความแสดงหลายบรรทัด */
            cursor: pointer;
            /* เปลี่ยน cursor เป็น pointer เมื่อ hover */
        }

        .flatpickr-calendar {
            position: absolute;
            left: 50%;
            /* จัดให้กลาง */
            transform: translateX(-100%);
            /* ปรับให้ตรงกลางอย่างสมบูรณ์ */
            z-index: 1000;
            /* ให้ปฏิทินแสดงอยู่ด้านบน */
        }
    </style>
    <?!= include('loading')?>
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-primary text-white">
        <div class="container-fluid">
            <!-- Navbar brand with logo and text -->
            <a class="navbar-brand text-white" href="#">
                <img src="https://cdn-icons-png.flaticon.com/128/3652/3652191.png" alt="Logo"
                    style="height: 40px; margin-right: 10px;">
                ระบบปฏิทินแจ้งเตือนเวรประจำวัน
            </a>

            <!-- Toggler button for small screens -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Collapsible navbar links -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link text-white active" aria-current="page" href="#">หน้าแรก</a>
                    </li>
                    <!-- Add more nav items as needed -->
                </ul>
            </div>
            <!-- Login button aligned to the right -->
            <button class="btn btn-light ms-auto" type="button">เข้าสู่ระบบ</button>
        </div>
    </nav>
    <div class="container mb-3">
        <div class="row">
            <div class="col-md-12">
                <div class="card mt-4">
                    <div class="card-header d-flex align-items-center">
                        <h4 class="pt-1"> <i class="fa-solid fa-calendar-days"></i> ปฏิทินแจ้งเตือนเวรประจำวัน
                        </h4>
                        <button type="button" class="btn btn-primary btn-sm ms-auto" data-bs-toggle="modal"
                            data-bs-target="#eventModal" onclick="displayEventModal()"><i class="fa-solid fa-plus"></i>
                            เพิ่มเวรประจำวัน</button>
                    </div>
                    <div class="card-body">
                        <div class="card-body">
                            <div class="container">
                                <div id="calendar"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ส่วนท้ายของหน้า (Footer) -->
    <footer class="bg-light fw-bold text-center p-0 m-0">
        <p class="py-3">
            <!-- แทนที่โลโก้ด้วยคำว่า Copyright -->
            <span>Copyright © 2024 Created by</span>
            <a href="https://cpt.ac.th/" target="_blank" rel="noopener noreferrer"
                style="text-decoration: none;">
                CPT notify.
            </a>
            <span>| พัฒนาโดย สภานักเรียนโรงเรียนชลประทานผาแตก</span>
        </p>
    </footer>


    <!-- Modal -->
    <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalLabel">เพิ่มเหตุการณ์ใหม่</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="eventForm">
                        <div class="mb-3" hidden>
                            <label for="eventId" class="form-label">ID</label>
                            <input type="text" class="form-control" id="eventId" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="eventDate" class="form-label fw-bold">วันที่ <span
                                    class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="eventDate" required readonly>
                                <!-- ทำให้ #datePickerInput ใช้เพื่อเปิดปฏิทิน -->
                                <input type="text" class="form-control d-none" id="datePickerInput">
                                <button type="button" class="btn btn-outline-secondary d-none" id="showCalendarButton">เลือก</button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="eventTitle" class="fw-bold">หัวเรื่อง <span class="text-danger">*</span></label>
                            <input type="text" id="eventTitle" class="form-control" placeholder="กรอกชื่อเรื่อง/หัวข้อ"
                                required>
                        </div>

                        <div class="mb-3">
                            <label for="eventDay" class="fw-bold">เลือกวันเวร: <span class="text-danger">*</span></label>
                            <select class="form-select" id="eventDay" required>
                                <option value="" selected>--เลือกวันเวร--</option>
                                <option value="จันทร์">วันจันทร์</option>
                                <option value="อังคาร">วันอังคาร</option>
                                <option value="พุธ">วันพุธ</option>
                                <option value="พฤหัสบดี">วันพฤหัสบดี</option>
                                <option value="ศุกร์">วันศุกร์</option>
                            </select>
                        </div>
                        <!-- Dynamic Table Section -->
                        <div class="mb-3">
                            <label for="dynamicTable" class="form-label fw-bold">รายการกิจกรรม <span
                                    class="text-danger">*</span></label>
                            <table class="table table-striped table-bordered" id="dynamicTable">
                                <thead>
                                    <tr>
                                        <th scope="col" style="width: 150px;">ชื่อนักเรียน</th>
                                        <th scope="col" style="width: 250px;">กิจกรรม/หน้าที่</th>
                                        <th scope="col" style="width: 10px;">ลบ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dynamic rows will be added here -->
                                </tbody>
                            </table>
                            <button type="button" class="btn btn-success" id="addRowBtn"><i
                                    class="fa-solid fa-plus"></i> เพิ่มแถว</button>
                        </div>

                        <hr>
                        <button type="submit" id="saveEventBtn" class="btn btn-primary">บันทึก</button>
                        <button type="button" class="btn btn-danger d-none" id="deleteDataEventBtn"
                            onclick="deleteDataEvent()"><i class="fa-solid fa-trash-can"></i> ลบข้อมูล</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i
                                class="fa-regular fa-circle-xmark"></i> ยกเลิก</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            // กำหนดค่าการตั้งเริ่มต้นของ Flatpickr
            var datepicker = flatpickr("#datePickerInput", {
                // กำหนดรูปแบบวันที่เป็น "YYYY-MM-DD"
                dateFormat: "Y-m-d", // รูปแบบวันที่ที่เก็บเป็นปี-เดือน-วัน

                // ตั้งค่าภาษาให้เป็นภาษาไทย
                locale: "th", // ใช้ locale ของไทยเพื่อแสดงภาษาไทย

                // สร้าง input สำรองเพื่อแสดงผลการเลือกวันที่
                altInput: true, // เปิดการใช้งาน altInput สำหรับการแสดงวันที่ในรูปแบบที่อ่านง่าย

                // กำหนดรูปแบบการแสดงวันที่ใน altInput
                altFormat: "d MM พ.ศ. Y", // รูปแบบวันที่ที่จะแสดงใน input สำรอง เช่น "8 ธันวาคม พ.ศ. 2567"

                // แก้ไขปีที่แสดงเป็นปีพุทธศักราช (เพิ่ม 543 ปี)
                yearOffset: 543, // เพิ่ม 543 เพื่อแสดงปีพุทธศักราช

                // ฟังก์ชันที่จะถูกเรียกเมื่อมีการเปลี่ยนแปลงวันที่
                onChange: function (selectedDates, dateStr) {
                    // อัปเดตค่าของ input #eventDate เมื่อเลือกวันที่
                    $('#eventDate').val(dateStr); // ใช้ dateStr ที่ได้จากการเลือกวันที่
                },

                // กำหนดให้ปฏิทินแสดงผลหลังจากปุ่ม showCalendarButton
                appendTo: document.querySelector("#showCalendarButton") // ใช้ querySelector เพื่อให้มั่นใจว่าอิลิเมนต์สามารถ append ได้
            });

            // เพิ่ม event listener ให้กับปุ่ม #showCalendarButton
            $('#showCalendarButton').on('click', function () {
                // เมื่อคลิกที่ปุ่มให้เปิด flatpickr
                datepicker.open(); // เปิดหน้าต่างปฏิทินของ Flatpickr
            });
        });
    </script>
    <script>
        // ตัวแปรสำหรับเก็บข้อมูลนักเรียน, วันที่จับฉลาก, และกิจกรรม
        let dataTeacherInfo; // เก็บข้อมูลนักเรียนและวันที่จับฉลากมา
        let dataActivities = []; // เก็บข้อมูลกิจกรรม

        // เมื่อเอกสารโหลดเสร็จ ให้เริ่มทำงาน
        $(document).ready(function () {
            // เริ่มโหลดข้อมูล
            loadingStart();

            // ฟังก์ชันดึงข้อมูลกิจกรรม จากชีท EvenInfo
            google.script.run.withSuccessHandler(function (result) {
                loadingEnd(); // หยุดการโหลด
                dataActivities = result; // เก็บข้อมูลกิจกรรมที่ดึงมา
                // console.log("กิจกรรมที่ดึงมา:", dataActivities);  // แสดงข้อมูลใน console
            }).getDataEvenInfo();  // เรียกฟังก์ชัน getDataEvenInfo

            // แสดงปฏิทิน
            calendarviweRA();

            // เมื่อมีการ submit ฟอร์ม
            $('#eventForm').on('submit', function (e) {
                e.preventDefault();  // หยุดการ submit ฟอร์ม
                submitevent(this);   // เรียกฟังก์ชัน submitevent
            });

            // ฟังก์ชันดึงข้อมูลนักเรียนและวันเวร จากชีท TeacherInfo
            google.script.run.withSuccessHandler(function (result) {
                dataTeacherInfo = result; // เก็บข้อมูลนักเรียนที่ดึงมา
                // console.log("ข้อมูลลิส :", dataTeacherInfo[0]); // แสดงข้อมูลใน console
            }).getDataTeacherInfo(); // เรียกฟังก์ชัน getDataTeacherInfo

            // เมื่อเลือกวันจาก eventDay ให้กรองข้อมูลนักเรียนตามวันที่
            $('#eventDay').on('change', function () {
                const selectedDay = $(this).val(); // รับค่าจากการเลือกวัน

                // ตรวจสอบว่ามีข้อมูลนักเรียนและแถวที่ 3 หรือไม่
                if (dataTeacherInfo && dataTeacherInfo.length > 2) {
                    // กรองข้อมูลนักเรียนที่ตรงกับ selectedDay (คอลัม B)
                    const teacherSelect = dataTeacherInfo.filter(teacher => teacher[1] === selectedDay)
                        .map(teacher => teacher[2]); // ดึงชื่อนักเรียนจากคอลัม C

                    // อัปเดต input ให้เป็น select สำหรับเลือกนักเรียน
                    $('#dynamicTable tbody tr td:first-child input').each(function () {
                        const currentValue = $(this).val(); // ค่าเดิมใน input
                        const selectElement = $('<select>', {
                            'class': 'form-control',
                            'required': true
                        });

                        // เพิ่ม option ว่างเปล่า
                        selectElement.append($('<option>', {
                            value: '',
                            text: '--เลือกนักเรียน--',
                            selected: true
                        }));

                        // เพิ่ม option นักเรียนที่กรองได้
                        teacherSelect.forEach(teacherName => {
                            selectElement.append($('<option>', {
                                value: teacherName,
                                text: teacherName,
                                selected: currentValue === teacherName
                            }));
                        });

                        // แทนที่ input ด้วย select
                        $(this).replaceWith(selectElement);
                    });
                }
            });
        });

        // เพิ่ม event listener สำหรับการเพิ่มแถวใหม่ในตาราง
        document.getElementById('addRowBtn').addEventListener('click', function () {
            const tableBody = document.querySelector('#dynamicTable tbody'); // ดึง tbody ของตาราง
            const newRow = document.createElement('tr'); // สร้างแถวใหม่

            // ดึงวันที่จาก eventDay
            const selectedDay = $('#eventDay').val();

            // สร้าง select สำหรับเลือกนักเรียน
            let teacherSelectHtml = '<select class="form-control" required><option value="">--เลือกนักเรียน--</option>';

            // กรองข้อมูลนักเรียนจาก dataTeacherInfo ตามวันที่ที่เลือก
            if (dataTeacherInfo && dataTeacherInfo.length > 2) {
                // กรองข้อมูลนักเรียนจากคอลัม B (วัน) และคอลัม C (ชื่อนักเรียน)
                const teacherSelect = dataTeacherInfo.filter(teacher => teacher[1] === selectedDay)
                    .map(teacher => teacher[2]); // ดึงชื่อนักเรียนจากคอลัม C

                // เพิ่ม option สำหรับนักเรียนที่กรองได้
                teacherSelect.forEach(teacherName => {
                    teacherSelectHtml += `<option value="${teacherName}">${teacherName}</option>`;
                });
            }
            teacherSelectHtml += '</select>';

            // สร้าง select สำหรับกิจกรรม
            let activitySelectHtml = '<select class="form-control" required><option value="">--เลือกกิจกรรม--</option>';
            if (dataActivities && dataActivities.length > 0) {
                // เพิ่มกิจกรรมจาก dataActivities
                dataActivities.forEach(activity => {
                    activitySelectHtml += `<option value="${activity}">${activity}</option>`;
                });
            }
            activitySelectHtml += '</select>';

            // สร้างแถวใหม่พร้อม select สำหรับเลือกนักเรียนและกิจกรรม
            newRow.innerHTML = `
        <td>${teacherSelectHtml}</td>   <!-- สร้าง select สำหรับนักเรียน -->
        <td>${activitySelectHtml}</td>  <!-- สร้าง select สำหรับกิจกรรม -->
        <td><button type="button" class="btn btn-danger removeRowBtn"> <i class="fa-solid fa-trash"></i></button></td>  <!-- ปุ่มลบแถว -->
    `;

            // เพิ่มแถวใหม่ลงในตาราง
            tableBody.appendChild(newRow);

            // เพิ่ม event listener สำหรับลบแถวใหม่
            newRow.querySelector('.removeRowBtn').addEventListener('click', function () {
                tableBody.removeChild(newRow);  // ลบแถวที่เลือก
            });
        });

        // ฟังก์ชันสำหรับแสดงปฏิทิน
        function calendarviweRA() {
            // เรียกใช้ Google Apps Script เพื่อดึงข้อมูลเหตุการณ์
            google.script.run.withSuccessHandler(function (events) {
                var calendarEl = document.getElementById('calendar');  // ดึงองค์ประกอบของปฏิทินจาก HTML

                // สร้างปฏิทินใหม่ด้วย FullCalendar
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    // กำหนดการแสดงผลเริ่มต้นของปฏิทิน (แสดงแบบเดือน)
                    initialView: 'dayGridMonth',

                    // เปิดการแสดงปัจจุบันในปฏิทิน
                    nowIndicator: true,

                    // กำหนดภาษาของปฏิทินเป็นภาษาไทย
                    locale: 'th',

                    // กำหนดปุ่มในส่วน header ของปฏิทิน
                    headerToolbar: {
                        left: 'prev,next today',  // ปุ่มก่อนหน้า, ถัดไป, วันนี้
                        center: 'title',          // ตรงกลางแสดงชื่อเดือน
                        right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek',  // ปุ่มสำหรับเปลี่ยนมุมมอง
                    },

                    // กำหนดข้อความปุ่มให้เป็นภาษาไทย
                    buttonText: {
                        today: 'วันนี้',
                        month: 'เดือน',
                        week: 'สัปดาห์',
                        day: 'วัน',
                        list: 'กำหนดการ',
                    },

                    // ข้อมูลเหตุการณ์ที่ดึงมาจาก Google Apps Script
                    events: events,

                    // กำหนดรูปแบบการแสดงเนื้อหาของกิจกรรมในปฏิทิน
                    eventContent: function (info) {
                        if (info.event.title) {
                            // ถ้ามีชื่อกิจกรรม ให้แสดงชื่อกิจกรรม
                            var description = `<div class="fc-event-title">${info.event.title}</div>`;
                            var content = `<div class="fc-event-title-container">${description}</div>`;
                            return { html: content }; // คืนค่ากลับเป็น HTML สำหรับแสดง
                        }
                        return {};  // หากไม่มีชื่อกิจกรรม คืนค่าเป็นว่าง
                    },

                    // เมื่อคลิกวันที่ในปฏิทิน
                    dateClick: function (info) {
                        const clickedDate = info.dateStr;  // เก็บวันที่ที่ถูกคลิกในรูปแบบ YYYY-MM-DD

                        // กรองกิจกรรมที่ตรงกับวันที่ที่คลิก
                        const dayEvents = events.filter(event =>
                            new Date(event.start).toDateString() === new Date(info.dateStr).toDateString()
                        );

                        // หากมีกิจกรรมในวันนั้นแสดงรายละเอียดกิจกรรม
                        if (dayEvents.length > 0) {
                            displayEventDetailsModal(dayEvents, clickedDate); // ส่งข้อมูลกิจกรรมและวันที่ไปที่ฟังก์ชัน modal เมื่อมีกิจกรรม
                        } else {
                            displayEventModal(info.dateStr);  // หากไม่มีกิจกรรม แสดง modal สำหรับวันที่นั้น 
                        }
                    },

                    // เมื่อคลิกกิจกรรมในปฏิทิน
                    eventClick: function (info) {
                        const event = info.event;  // ดึงข้อมูลกิจกรรมที่คลิก
                        const fullEventData = events.find(e => e.id === event.id);  // ค้นหาข้อมูลกิจกรรมที่ครบถ้วนจาก events
                        displaySingleEventModal(fullEventData);  // แสดงรายละเอียดกิจกรรมใน modal
                    }
                });

                // เรนเดอร์ (แสดง) ปฏิทินในหน้าเว็บ
                calendar.render();
            }).getCalendarData();  // เรียกใช้ฟังก์ชันเพื่อดึงข้อมูลกิจกรรมจาก Google Apps Script
        }

        // ฟังก์ชันแสดงรายละเอียดเหตุการณ์เมื่อมีหลายเหตุการณ์ในวันเดียวกัน
        function displayEventDetailsModal(events, clickedDate) {
            // แปลงวันที่ที่คลิกมาให้เป็นรูปแบบที่ต้องการ เช่น "7 ธันวาคม 2024"
            const date = new Date(clickedDate);  // แปลงวันที่จาก clickedDate ให้เป็นรูปแบบ Date object
            const options = { year: 'numeric', month: 'long', day: 'numeric' };  // กำหนดรูปแบบการแสดงวันที่
            const formattedDate = date.toLocaleDateString('th-TH', options);  // แปลงวันที่ให้เป็นภาษาไทย

            // เริ่มสร้าง HTML สำหรับแสดงรายการเหตุการณ์ในรูปแบบตาราง
            let eventListHtml = '<table class="table table-bordered">';  // กำหนดโครงสร้างของตาราง

            // เพิ่มส่วนหัวของตารางที่แสดง "รายละเอียดเวรประจำวัน"
            eventListHtml += `
        <thead>
            <tr>
                <th colspan="2" style="text-align: center;">รายละเอียดเวรประจำวัน</th>
            </tr>
        </thead>
        <tbody>
    `;

            // วนลูปผ่านทุกเหตุการณ์ในวันนั้นเพื่อแสดงข้อมูลในตาราง
            events.forEach((event) => {
                let descriptionDetails = '';  // ตัวแปรสำหรับเก็บรายละเอียดของเหตุการณ์

                // ตรวจสอบว่ามีรายละเอียดของเหตุการณ์ (description) หรือไม่
                if (event.description) {
                    try {
                        // พยายามแปลงข้อมูล description ที่เป็น JSON
                        const activities = JSON.parse(event.description);

                        // ตรวจสอบว่าเป็น array และมีข้อมูลใน array หรือไม่
                        if (Array.isArray(activities) && activities.length > 0) {
                            descriptionDetails = '<ol>';  // ใช้ <ol> เพื่อแสดงเป็นลำดับ
                            activities.forEach((activity) => {
                                descriptionDetails += `
                            <li>
                                ${activity.teacherName || 'ไม่ระบุ'}  <!-- ชื่อนักเรียน (ถ้ามี) -->
                                : ${activity.activity || 'ไม่ระบุ'}  <!-- กิจกรรม (ถ้ามี) -->
                            </li>
                        `;
                            });
                            descriptionDetails += '</ol>';  // ปิด <ol> หลังจากแสดงกิจกรรมทั้งหมด
                        }
                    } catch (e) {
                        // หากแปลง JSON ไม่สำเร็จ ให้แสดงรายละเอียดที่มีอยู่ตามปกติ
                        descriptionDetails = event.description;
                    }
                }

                // แถวที่ 2: แสดงหัวข้อ "หัวเรื่อง" ของกิจกรรม
                eventListHtml += `
            <tr>
                <td style="width: 30%;"><strong>หัวเรื่อง</strong></td>
                <td style="width: 70%;">${event.title}</td>  <!-- แสดงชื่อหัวเรื่อง -->
            </tr>
        `;

                // แถวที่ 3: แสดงหัวข้อ "หน้าที่" ของกิจกรรม
                eventListHtml += `
            <tr>
                <td style="width: 30%;"><strong>หน้าที่</strong></td>
                <td style="width: 70%;">${descriptionDetails ? descriptionDetails : 'ไม่มีรายละเอียด'}</td>  <!-- แสดงรายละเอียดกิจกรรมหรือข้อความ 'ไม่มีรายละเอียด' -->
            </tr>
        `;
            });

            // ปิดส่วนของตาราง
            eventListHtml += '</tbody></table>';

            // แสดง SweetAlert กับรายการเหตุการณ์ในรูปแบบตาราง
            Swal.fire({
                title: `เวรประจำวันที่ ${formattedDate}`,  // ใช้วันที่ที่คลิกมาใน title
                html: eventListHtml,  // แสดง HTML ตารางเหตุการณ์
                showConfirmButton: false,  // ซ่อนปุ่ม "ตกลง"
                showCancelButton: true,  // แสดงปุ่ม "ยกเลิก"
                cancelButtonText: 'ตกลง',  // ปุ่ม "ตกลง"
                cancelButtonColor: '#3085d6'  // กำหนดสีของปุ่ม "ตกลง"
            });
        }

        // ฟังก์ชันแสดงข้อมูลใน Modal เพื่อ แก้ไข เหตุการณ์
        function displaySingleEventModal(event) {
            // กรอกข้อมูลที่เกี่ยวกับเหตุการณ์ลงในฟอร์ม
            $('#eventId').val(event.id);  // กรอก ID ของเหตุการณ์
            $('#eventDate').val(event.start);  // กรอกวันที่เริ่มต้นเหตุการณ์ (ยังคงเก็บไว้ในรูปแบบที่ไม่ได้แปลงเป็น toISOString)
            $('#eventTitle').val(event.title || '');  // กรอกหัวเรื่องของเหตุการณ์ (ถ้าไม่มีให้ใส่ค่าว่าง)
            $('#eventDay').val(event.day || '');  // กรอกวันของเหตุการณ์ (ถ้าไม่มีให้ใส่ค่าว่าง)

            // ล้างข้อมูลเก่าจากตาราง dynamicTable ก่อนที่จะเพิ่มข้อมูลใหม่
            $('#dynamicTable tbody').empty();
                try {
                    // แปลงข้อมูลจาก JSON ที่อยู่ในคอลัมน์ D ของ event.description เป็น Array
                    const activities = JSON.parse(event.description);

                    // ตรวจสอบว่าเป็น Array และมีข้อมูลหรือไม่
                    if (Array.isArray(activities) && activities.length > 0) {
                        // วนลูปผ่านแต่ละกิจกรรมใน Array และเพิ่มข้อมูลเข้าไปในตาราง
                        activities.forEach(function (activity) {
                            // สร้างแถวใหม่สำหรับข้อมูลในตาราง dynamicTable
                            const newRow = document.createElement('tr');

                            // สร้าง select สำหรับเลือกชื่อนักเรียน
                            let teacherSelectHtml = '<select class="form-control" required><option value="">--เลือกนักเรียน--</option>';

                            // กรองข้อมูลนักเรียนจาก dataTeacherInfo ตามวันที่ที่เลือก
                            const selectedDay = $('#eventDay').val(); // ใช้วันที่ที่เลือกจาก modal
                            if (dataTeacherInfo && dataTeacherInfo.length > 2) {
                                const teacherSelect = dataTeacherInfo.filter(teacher => teacher[1] === selectedDay)
                                    .map(teacher => teacher[2]); // กรองชื่อนักเรียนจากคอลัมน์ C

                                // เพิ่มตัวเลือกนักเรียนที่กรองได้ลงใน select
                                teacherSelect.forEach(function (teacherName) {
                                    teacherSelectHtml += `<option value="${teacherName}" ${teacherName === activity.teacherName ? 'selected' : ''}>${teacherName}</option>`;
                                });
                            }
                            teacherSelectHtml += '</select>';

                            // สร้าง select สำหรับเลือกกิจกรรม
                            let activitySelectHtml = '<select class="form-control" required><option value="">--เลือกกิจกรรม--</option>';

                            // กรองข้อมูลกิจกรรมจาก dataActivities
                            if (dataActivities && dataActivities.length > 0) {
                                dataActivities.forEach(function (activityOption) {
                                    activitySelectHtml += `<option value="${activityOption}" ${activityOption === activity.activity ? 'selected' : ''}>${activityOption}</option>`;
                                });
                            }
                            activitySelectHtml += '</select>';

                            // สร้างแถวใหม่ในตาราง dynamicTable พร้อม select สำหรับนักเรียนและกิจกรรม
                            newRow.innerHTML = `
                        <td>${teacherSelectHtml}</td>
                        <td>${activitySelectHtml}</td>
                        <td><button type="button" class="btn btn-danger removeRowBtn"><i class="fa-solid fa-trash"></i></button></td>
                    `;

                            // เพิ่มแถวใหม่ลงใน tbody ของ dynamicTable
                            $('#dynamicTable tbody').append(newRow);

                            // เพิ่ม event listener สำหรับลบแถว
                            newRow.querySelector('.removeRowBtn').addEventListener('click', function () {
                                newRow.remove();  // ลบแถวที่คลิก
                            });
                        });
                    } else {
                        console.log('ข้อมูลรายละเอียด (description) ไม่ใช่ array หรือว่างเปล่า');
                    }
                } catch (e) {
                    console.log('ไม่สามารถแปลงข้อมูล description ได้:', e);
                }
            

            // แสดงปุ่ม "ลบข้อมูล" และซ่อนปุ่ม "แสดงปฏิทิน"
            $('#deleteDataEventBtn').removeClass('d-none');

            // ซ่อนปุ่มเลือกปฏิทิน
            $('#showCalendarButton').addClass('d-none');

            // เปลี่ยนข้อความในหัวของ Modal เป็น "แก้ไขข้อมูลเวรประจำวัน"
            const icon = '<i class="fa-solid fa-pen-to-square"></i>';  // ไอคอนที่จะแสดงในหัว Modal
            document.getElementById("eventModalLabel").innerHTML = icon + " แก้ไขข้อมูลเวรประจำวัน";  // เปลี่ยนหัวข้อ

            // เปลี่ยนข้อความของปุ่ม "บันทึก" ให้เป็น "แก้ไขข้อมูล"
            $('#saveEventBtn').html('<i class="fa-solid fa-floppy-disk"></i> แก้ไขข้อมูล');

            // แสดง Modal ที่ใช้ในการแก้ไขข้อมูล
            $('#eventModal').modal('show');
        }

        // ฟังก์ชันแสดงข้อมูลใน Modal สำหรับเพิ่มข้อมูลใหม่
        function displayEventModal(dateStr) {
            // กรอกวันที่ที่เลือกลงในฟอร์ม
            $('#eventDate').val(dateStr);

            // ล้าง ID และข้อมูลเดิมในฟอร์ม
            $('#eventId').val('');
            $('#eventTitle').val('');  // ล้างหัวเรื่อง
            $('#eventDay').val('');  // ล้างวัน

            // ล้างตาราง dynamicTable ก่อนแสดงข้อมูลใหม่
            $('#dynamicTable tbody').empty();

            // สร้างแถวใหม่ในตาราง dynamicTable
            const tableBody = document.querySelector('#dynamicTable tbody');
            const selectedDay = $('#eventDay').val();  // ดึงวันที่จากฟอร์ม (ยังไม่มีการเลือก)

            // สร้างแถวใหม่
            const newRow = document.createElement('tr');

            // สร้าง select สำหรับเลือกชื่อนักเรียน
            let teacherSelectHtml = '<select class="form-control" required><option value="">--เลือกนักเรียน--</option>';

            // กรองนักเรียนจาก dataTeacherInfo ตามวันที่เลือก
            if (dataTeacherInfo && dataTeacherInfo.length > 2) {
                const teacherSelect = dataTeacherInfo.filter(teacher => teacher[1] === selectedDay)
                    .map(teacher => teacher[2]);  // ดึงชื่อนักเรียนจากคอลัม C

                // เพิ่มตัวเลือกชื่อนักเรียนลงใน select
                teacherSelect.forEach(teacherName => {
                    teacherSelectHtml += `<option value="${teacherName}">${teacherName}</option>`;
                });
            }
            teacherSelectHtml += '</select>';

            // สร้าง select สำหรับเลือกกิจกรรม
            let activitySelectHtml = '<select class="form-control" required><option value="">--เลือกกิจกรรม--</option>';
            if (dataActivities && dataActivities.length > 0) {
                // เพิ่มกิจกรรมจาก dataActivities
                dataActivities.forEach(activity => {
                    activitySelectHtml += `<option value="${activity}">${activity}</option>`;
                });
            }
            activitySelectHtml += '</select>';

            // สร้างแถวใหม่ในตาราง พร้อม select สำหรับเลือกนักเรียนและกิจกรรม
            newRow.innerHTML = `
        <td>${teacherSelectHtml}</td>
        <td>${activitySelectHtml}</td>
        <td><button type="button" class="btn btn-danger removeRowBtn"><i class="fa-solid fa-trash"></i></button></td>
    `;

            // เพิ่มแถวใหม่ลงใน tbody ของ dynamicTable
            tableBody.appendChild(newRow);

            // เพิ่ม event listener สำหรับลบแถวเมื่อคลิกปุ่ม "ลบ"
            newRow.querySelector('.removeRowBtn').addEventListener('click', function () {
                tableBody.removeChild(newRow);  // ลบแถว
            });

            // การฟังก์ชันสำหรับการเลือกวัน เช่น จันทร์,อังคาร ในฟอร์ม
            $('#eventDay').on('change', function () {
                const selectedDay = $(this).val();  // ดึงวันที่ที่เลือก

                // ตรวจสอบว่ามีข้อมูลนักเรียนและแถวที่ 3 หรือไม่
                if (dataTeacherInfo && dataTeacherInfo.length > 2) {
                    // สำหรับแต่ละแถวในตาราง dynamicTable
                    $('#dynamicTable tbody tr').each(function () {
                        const currentTeacherSelect = $(this).find('select').eq(0);  // select นักเรียน
                        const currentActivitySelect = $(this).find('select').eq(1);  // select กิจกรรม

                        // กรองข้อมูลนักเรียนใหม่ตามวันที่ที่เลือก
                        const teacherSelect = dataTeacherInfo.filter(teacher => teacher[1] === selectedDay)
                            .map(teacher => teacher[2]);  // ดึงชื่อนักเรียนจากคอลัม C
                        const currentTeacherValue = currentTeacherSelect.val();

                        // สร้าง select ใหม่ที่กรองตามชื่อนักเรียน
                        const updatedTeacherSelect = $('<select>', { 'class': 'form-control', 'required': true });
                        updatedTeacherSelect.append($('<option>', { value: '', text: '--เลือกนักเรียน--' }));
                        teacherSelect.forEach(teacherName => {
                            updatedTeacherSelect.append($('<option>', {
                                value: teacherName,
                                text: teacherName,
                                selected: currentTeacherValue === teacherName
                            }));
                        });

                        // กรองกิจกรรมใหม่
                        const activitiesList = dataActivities;
                        const currentActivityValue = currentActivitySelect.val();
                        const updatedActivitySelect = $('<select>', { 'class': 'form-control', 'required': true });
                        updatedActivitySelect.append($('<option>', { value: '', text: '--เลือกกิจกรรม--' }));
                        activitiesList.forEach(activity => {
                            updatedActivitySelect.append($('<option>', {
                                value: activity,
                                text: activity,
                                selected: currentActivityValue === activity
                            }));
                        });

                        // แทนที่ select เดิมด้วย select ที่อัพเดตแล้ว
                        currentTeacherSelect.replaceWith(updatedTeacherSelect);
                        currentActivitySelect.replaceWith(updatedActivitySelect);
                    });
                }
            });

            // ซ่อนปุ่มลบข้อมูลและแสดงปุ่มแสดงปฏิทิน
            $('#deleteDataEventBtn').addClass('d-none');

            // แสดงปุ่มเลือกปฏิทิน
            $('#showCalendarButton').removeClass('d-none'); 

            // เปลี่ยนข้อความในหัวของ Modal
            const icon = '<i class="fa-solid fa-pen-to-square"></i>';  // สัญลักษณ์ไอคอน
            document.getElementById("eventModalLabel").innerHTML = icon + " เพิ่มข้อมูลเวรประจำวันใหม่";  // ชื่อโมดัล

            // เปลี่ยนข้อความในปุ่ม "บันทึก" เป็น "เพิ่มข้อมูล"
            $('#saveEventBtn').html('<i class="fa-solid fa-floppy-disk"></i> เพิ่มข้อมูล');

            // แสดง Modal สำหรับการเพิ่มข้อมูล
            $('#eventModal').modal('show');
        }

        // ฟังก์ชันสำหรับเมื่อคลิกปุ่มบันทึกใน Modal
        function submitevent(event){
            // ตรวจสอบว่ามีแถวในตาราง dynamicTable หรือไม่
            if ($('#dynamicTable tbody tr').length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'กรุณาเพิ่มรายการ',
                    text: 'ต้องมีรายการอย่างน้อย 1 รายการ'
                });
                return;  // หากไม่มีแถวในตารางให้หยุดการทำงาน
            }

            // ตรวจสอบว่ามีการกรอกวันที่หรือไม่
            const eventDate = $('#eventDate').val();
            if (!eventDate) {
                Swal.fire({
                    icon: 'error',
                    title: 'กรุณากรอกวันที่',
                    text: 'ต้องเลือกวันที่ให้ครบถ้วน'
                });
                return;  // หากไม่มีวันที่ให้หยุดการทำงาน
            }

            // รวบรวมข้อมูลจากฟอร์ม
            const formData = {
                eventId: $('#eventId').val(),  // ดึง eventId
                date: $('#eventDate').val(),  // ดึงวันที่
                title: $('#eventTitle').val(),  // ดึงหัวเรื่อง
                day: $('#eventDay').val(),  // ดึงวัน
                dynamicData: []  // สร้างอาร์เรย์เพื่อเก็บข้อมูลจาก dynamicTable
            };

            // ดึงข้อมูลจาก dynamicTable
            $('#dynamicTable tbody tr').each(function () {
                const teacherName = $(this).find('td').eq(0).find('select').val();  // ดึงชื่อนักเรียนจาก select ในคอลัมน์แรก
                const activity = $(this).find('td').eq(1).find('select').val();  // ดึงกิจกรรมจาก select ในคอลัมน์ที่สอง

                // ตรวจสอบว่าเลือกชื่อนักเรียนและกิจกรรมหรือไม่
                if (teacherName && activity) {
                    // หากครบถ้วน ให้เพิ่มข้อมูลลงใน dynamicData
                    formData.dynamicData.push({
                        teacherName: teacherName,
                        activity: activity
                    });
                } else {
                    // หากข้อมูลไม่ครบถ้วนให้แสดงข้อความเตือน
                    Swal.fire({
                        icon: 'error',
                        title: 'กรุณากรอกข้อมูลให้ครบถ้วน',
                        text: 'ทั้งชื่อนักเรียนและกิจกรรมต้องกรอกให้ครบถ้วน'
                    });
                    return;  // หากข้อมูลไม่ครบให้หยุดการทำงาน
                }
            });

            // แสดงข้อความยืนยันการบันทึกข้อมูล
            Swal.fire({
                title: 'ยืนยันการบันทึกข้อมูล?',
                text: 'กรุณาตรวจสอบข้อมูลให้ถูกต้องก่อนยืนยัน!',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ยืนยัน',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    // หากไม่มี eventId แสดงว่าเป็นการบันทึกข้อมูลใหม่
                    if (formData.eventId === "") {
                        loadingStart();  // แสดงโลดดิ้ง

                        // เรียกใช้งานฟังก์ชันบันทึกข้อมูล
                        google.script.run.withSuccessHandler(function (response) {
                            loadingEnd();  // ซ่อนโลดดิ้ง

                            // หากบันทึกข้อมูลสำเร็จ
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: response.success ? 'บันทึกข้อมูลสำเร็จ' : 'ข้อมูลซ้ำ',
                                    showConfirmButton: false,
                                    timer: 1500
                                });
                                $('#eventModal').modal('hide');  // ปิด Modal
                                calendarviweRA();  // รีเฟรชปฏิทิน
                            } else {
                                // หากเกิดข้อผิดพลาด
                                Swal.fire({
                                    icon: 'error',
                                    title: response.message,  // แสดงข้อความจาก server
                                    text: 'กรุณาเลือกวันที่ใหม่แล้วลองอีกครั้ง!',
                                    showConfirmButton: true
                                });
                            }
                        }).saveEventToCalendarSheet(formData);  // เรียกฟังก์ชัน saveEventToCalendarSheet
                    } else {
                        loadingStart();  // แสดงโลดดิ้ง

                        // หากมี eventId แสดงว่าเป็นการแก้ไขข้อมูล
                        google.script.run.withSuccessHandler(function (response) {
                            loadingEnd();  // ซ่อนโลดดิ้ง

                            // หากแก้ไขข้อมูลสำเร็จ
                            Swal.fire({
                                icon: 'success',
                                title: 'แก้ไขข้อมูลสำเร็จ',
                                showConfirmButton: true
                            });

                            // ปิด Modal
                            $('#eventModal').modal('hide');

                            // รีเฟรชปฏิทิน
                            calendarviweRA();
                        }).updateEventToCalendarSheet(formData);  // เรียกฟังก์ชัน updateEventToCalendarSheet
                    }
                }
            });
        }

        // ฟังก์ชันลบข้อมูลเมื่อผู้ใช้คลิกปุ่มลบ
        function deleteDataEvent() {
            // 1. ดึงค่า eventId, eventDate และ eventTitle จากฟอร์ม
            const eventId = $('#eventId').val();  // ดึง eventId จากฟอร์ม
            const eventDate = new Date($('#eventDate').val());  // แปลง eventDate จากค่าวันที่ในฟอร์มให้เป็น Date object
            const eventTitle = $('#eventTitle').val();  // ดึงชื่อกิจกรรมจากฟอร์ม

            // 2. ตรวจสอบว่า eventId มีค่าหรือไม่
            // หากไม่มี eventId แสดงว่าไม่สามารถลบข้อมูลได้
            if (!eventId) {
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่พบข้อมูลที่ต้องการลบ',
                    text: 'กรุณาระบุ eventId ที่ต้องการลบ'
                });
                return;  // หากไม่พบ eventId ให้หยุดการทำงาน
            }

            // 3. กำหนดรูปแบบวันที่ (วัน, เดือน, ปี) เพื่อแสดงในข้อความยืนยัน
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = eventDate.toLocaleDateString('th-TH', options);  // แปลง eventDate เป็นวันที่ในภาษาไทย

            // 4. ยืนยันการลบข้อมูลผ่าน Swal
            Swal.fire({
                title: `ลบข้อมูล ${formattedDate}`,  // แสดงวันที่ที่ผู้ใช้เลือก
                text: `กิจกรรม/เหตุการณ์: "${eventTitle}"`,  // แสดงชื่อกิจกรรม/เหตุการณ์
                icon: 'warning',
                showCancelButton: true,  // แสดงปุ่มยกเลิก
                confirmButtonText: 'ใช่,ลบ',  // ปุ่มยืนยันลบ
                cancelButtonText: 'ไม่,ยกเลิก'  // ปุ่มยกเลิก
            }).then((result) => {
                // 5. หากผู้ใช้กด "ใช่,ลบ"
                if (result.isConfirmed) {
                    loadingStart();  // เริ่มแสดงสัญลักษณ์ loading

                    // 6. เรียกฟังก์ชันจาก Google Apps Script เพื่อทำการลบข้อมูล
                    google.script.run.withSuccessHandler(function (response) {
                        loadingEnd();  // ซ่อนสัญลักษณ์ loading

                        // 7. แสดงผลลัพธ์เมื่อลบข้อมูลสำเร็จ
                        Swal.fire({
                            icon: 'success',
                            title: 'ลบข้อมูลสำเร็จ',
                            showConfirmButton: false,  // ไม่ให้แสดงปุ่มยืนยัน
                            timer: 1500  // แสดงข้อความสำเร็จเป็นเวลา 1.5 วินาที
                        });

                        // 8. ปิด Modal
                        $('#eventModal').modal('hide');

                        // 9. รีเฟรชปฏิทินเพื่อให้ข้อมูลอัปเดต
                        calendarviweRA();
                    }).deleteEventFromCalendarSheet(eventId);  // เรียกฟังก์ชัน deleteEventFromCalendarSheet ใน Google Apps Script เพื่อลบข้อมูล
                }
            });
        }

    </script>

    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>

</html>
